{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %}
<!-- breadcrumb-section -->
<div class="breadcrumb-section breadcrumb-bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 text-center">
                <div class="breadcrumb-text">
                    <p>Secure Checkout</p>
                    <h1>Complete Your Order</h1>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end breadcrumb section -->

<!-- check out section -->
<div class="checkout-section mt-150 mb-150">
    <div class="container">
        {% if messages %}
        <div class="row">
            <div class="col-lg-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

            <!-- Replace the form section with this -->
            <form method="post" action="{% url 'checkout' %}" id="checkoutForm">
    {% csrf_token %}
                <!-- Add this at the top of your form -->
{% if messages %}
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Add 'is-invalid' class to invalid fields -->
{% for field in form %}
    {% if field.errors %}
        <div class="invalid-feedback">
            {% for error in field.errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
{% endfor %}
    <div class="row">
        <div class="col-lg-8">
            <div class="checkout-accordion-wrap">
                <div class="accordion" id="accordionExample">
                    <!-- Billing Address -->
                    <div class="card single-accordion">
                        <div class="card-header" id="headingOne">
                            <h5 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Billing Address
                                </button>
                            </h5>
                        </div>

                        <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="billing-address-form">
                                    <div class="row">
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_first_name">First Name*</label>
                                            <input type="text" class="form-control" name="billing_first_name"
                                                   id="id_billing_first_name" value="{{ user.first_name }}" required>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_last_name">Last Name*</label>
                                            <input type="text" class="form-control" name="billing_last_name"
                                                   id="id_billing_last_name" value="{{ user.last_name }}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_billing_email">Email*</label>
                                        <input type="email" class="form-control" name="billing_email"
                                               id="id_billing_email" value="{{ user.email }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_billing_phone">Phone*</label>
                                        <input type="tel" class="form-control" name="billing_phone"
                                               id="id_billing_phone" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_billing_street_address">Street Address*</label>
                                        <input type="text" class="form-control" name="billing_street_address"
                                               id="id_billing_street_address" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_billing_apartment_address">Apartment, Suite, etc (optional)</label>
                                        <input type="text" class="form-control" name="billing_apartment_address"
                                               id="id_billing_apartment_address">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_city">City*</label>
                                            <input type="text" class="form-control" name="billing_city"
                                                   id="id_billing_city" required>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_state">State/Province*</label>
                                            <input type="text" class="form-control" name="billing_state"
                                                   id="id_billing_state" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_zip">ZIP/Postal Code*</label>
                                            <input type="text" class="form-control" name="billing_zip"
                                                   id="id_billing_zip" required>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="id_billing_country">Country*</label>
                                            <select class="form-control" name="billing_country" id="id_billing_country" required>
                                                <option value="">Select Country</option>
                                                <option value="US">United States</option>
                                                <option value="CA">Canada</option>
                                                <option value="UK">United Kingdom</option>
                                                <option value="AU">Australia</option>
                                                <!-- Add more countries as needed -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="card single-accordion">
                        <div class="card-header" id="headingTwo">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Shipping Address
                                </button>
                            </h5>
                        </div>
                        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="shipping-address-form">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="sameAsBilling" name="same_as_billing">
                                        <label class="form-check-label" for="sameAsBilling">
                                            Same as billing address
                                        </label>
                                    </div>
                                    <div id="shippingFields">
                                        <div class="row">
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_first_name">First Name*</label>
                                                <input type="text" class="form-control" name="shipping_first_name"
                                                       id="id_shipping_first_name">
                                            </div>
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_last_name">Last Name*</label>
                                                <input type="text" class="form-control" name="shipping_last_name"
                                                       id="id_shipping_last_name">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="id_shipping_phone">Phone*</label>
                                            <input type="tel" class="form-control" name="shipping_phone"
                                                   id="id_shipping_phone">
                                        </div>
                                        <div class="form-group">
                                            <label for="id_shipping_street_address">Street Address*</label>
                                            <input type="text" class="form-control" name="shipping_street_address"
                                                   id="id_shipping_street_address">
                                        </div>
                                        <div class="form-group">
                                            <label for="id_shipping_apartment_address">Apartment, Suite, etc (optional)</label>
                                            <input type="text" class="form-control" name="shipping_apartment_address"
                                                   id="id_shipping_apartment_address">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_city">City*</label>
                                                <input type="text" class="form-control" name="shipping_city"
                                                       id="id_shipping_city">
                                            </div>
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_state">State/Province*</label>
                                                <input type="text" class="form-control" name="shipping_state"
                                                       id="id_shipping_state">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_zip">ZIP/Postal Code*</label>
                                                <input type="text" class="form-control" name="shipping_zip"
                                                       id="id_shipping_zip">
                                            </div>
                                            <div class="col-md-6 form-group">
                                                <label for="id_shipping_country">Country*</label>
                                                <select class="form-control" name="shipping_country" id="id_shipping_country">
                                                    <option value="">Select Country</option>
                                                    <option value="US">United States</option>
                                                    <option value="CA">Canada</option>
                                                    <option value="UK">United Kingdom</option>
                                                    <option value="AU">Australia</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">z
                                            <label for="id_shipping_notes">Shipping Notes</label>
                                            <textarea class="form-control" name="shipping_notes"
                                                      id="id_shipping_notes" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card single-accordion">
                        <div class="card-header" id="headingThree">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Payment Method
                                </button>
                            </h5>
                        </div>
                        <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="payment-method">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method"
                                               id="creditCard" value="credit_card" checked>
                                        <label class="form-check-label" for="creditCard">
                                            <i class="fab fa-cc-visa"></i> Credit/Debit Card
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method"
                                               id="paypal" value="paypal">
                                        <label class="form-check-label" for="paypal">
                                            <i class="fab fa-paypal"></i> PayPal
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method"
                                               id="cashOnDelivery" value="cash_on_delivery">
                                        <label class="form-check-label" for="cashOnDelivery">
                                            <i class="fas fa-money-bill-wave"></i> Cash on Delivery
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="order-details-wrap">
                <table class="order-details">
                    <thead>
                        <tr>
                            <th>Your Order</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody class="order-details-body">
                        {% for item in cart.items.all %}
                        <tr>
                            <td>{{ item.product.name }} × {{ item.quantity }}</td>
                            <td>${{ item.total_price|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody class="checkout-details">
                        <tr>
                            <td>Subtotal</td>
                            <td>${{ cart.total_price|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td>Shipping</td>
                            <td>
                                {% if cart.items.count > 0 %}
                                    $45.00
                                {% else %}
                                    $0.00
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Tax (13%)</td>
                            <td>${{ tax|floatformat:2 }}</td>
                        </tr>
                        <tr class="total">
                            <td><strong>Total</strong></td>
                            <td>
                                <strong>${{ total|floatformat:2 }}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Terms and Conditions Checkbox -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                    <label class="form-check-label" for="agreeTerms">
                        I agree to the <a href="#" data-toggle="modal" data-target="#termsModal">Terms and Conditions</a>
                    </label>
                </div>

                <button type="submit" class="boxed-btn" id="placeOrderBtn">Place Order</button>
            </div>
        </div>
    </div>
</form>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Add your terms and conditions here -->
                <p>By placing an order, you agree to our terms of service, privacy policy, and return policy...</p>
                <!-- More detailed terms can go here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
    </div>
</div>
<!-- end check out section -->
{% endblock %}
{% block extra_js %}
<script>
$(document).ready(function() {
    // Same as billing address checkbox functionality
    $('#sameAsBilling').change(function() {
        if(this.checked) {
            $('#shippingFields').hide();
            $('#shippingFields input, #shippingFields select, #shippingFields textarea').prop('disabled', true);
        } else {
            $('#shippingFields').show();
            $('#shippingFields input, #shippingFields select, #shippingFields textarea').prop('disabled', false);
        }
    });

    // Initialize form validation
    $('form').submit(function(e) {
        // You can add additional validation here if needed
        if ($('#sameAsBilling').is(':checked')) {
            // Clear shipping fields if same as billing
            $('#shippingFields input, #shippingFields select, #shippingFields textarea').val('');
        }
    });
});
</script>
{% endblock %}